% -----------------------------------------------
% Template for ISMIR Papers
% 2015 version, based on previous ISMIR templates
% -----------------------------------------------

\documentclass{article}
\usepackage{ismir,amsmath,cite}
\usepackage{graphicx}
\usepackage{color}
\usepackage{mathrsfs}
\usepackage[english]{babel}
\usepackage{caption}
\usepackage{subfig, color}
\usepackage{microtype}
\usepackage{IEEEtrantools}
\sloppy

\usepackage{xspace}
\newcommand*{\eg}{e.g.\@\xspace}
\newcommand*{\ie}{i.e.\@\xspace}
\newcommand*{\etal}{et al.\@\xspace}

% Title.
% ------
\title{Learning pitch invariants for instrument recognition}


% Single address
% To use with only one author or several with the same address
% ---------------
%\oneauthor
%{Names should be omitted for double-blind reviewing}
%{Affiliations should be omitted for double-blind reviewing}
%\oneauthor
%{Vincent Lostanlen, Carmine Emanuele Cella, and St\'{e}phane Mallat}
%{\'{E}cole normale sup\'{e}rieure}

% Two addresses
% --------------
\twoauthors
{First author} {School \\ Department}
{Second author} {Company \\ Address}

% Three addresses
% --------------
%\threeauthors
 %{First author} {Affiliation1 \\ {\tt author1@ismir.edu}}
 %{Second author} {\bf Retain these fake authors in\\\bf submission to preserve the formatting}
 %{Third author} {Affiliation3 \\ {\tt author3@ismir.edu}}

% Four addresses
% --------------
%\fourauthors
%  {First author} {Affiliation1 \\ {\tt author1@ismir.edu}}
%  {Second author}{Affiliation2 \\ {\tt author2@ismir.edu}}
%  {Third author} {Affiliation3 \\ {\tt author3@ismir.edu}}
%  {Fourth author} {Affiliation4 \\ {\tt author4@ismir.edu}}

\begin{document}
%
\maketitle
%
\begin{abstract}
Musical performance combines a wide range of pitches, nuances,
and expressive techniques.
Audio-based classification of musical instruments thus requires to
build signal representations that are invariant to such transformations.
This article investigates the construction
of multi-stage architectures for instrument recognition,
given a limited amount of annotated training data.
We show that the main drawback of mel-frequency cepstral
coefficients (MFCC) resides in their lack of invariance with respect to
realistic pitch shifts, despite being designed to be invariant
to the frequency transposition of pure tones.
In turn, a deep convolutional network (ConvNet)
in the time-frequency domain is able to disentangle pitch from
timbral information, hence yielding better classification accuracy.
We further improve the learned representation
by introducing weight sharing strategies dedicated to
quasi-harmonic sounds with fixed spectral envelope,
which are archetypal of musical notes.
\end{abstract}

\section{Introduction}\label{sec:introduction}
Among the cognitive attributes of musical tones, pitch is distinguished
by a combination of three properties.
First, it is relative: ordering pitches from low to high gives rise to
intervals and melodic patterns.
Secondly, it is intensive: multiple pitches heard simultaneously produce
a chord, not a single unified tone -- contrary to loudness, which adds
up with the number of sources.
Thirdly, it does not depend on instrumentation: this makes possible
the transcription of polyphonic music under a single symbolic system
\cite{deCheveigne2005}.

Tuning auditory filters to a perceptual scale of pitches provides a
time-frequency representation of music signals that satisfies the first two of these properties.
It is thus a starting point for a wide range of MIR applications,
which can be separated in two categories: pitch-\emph{relative}
(\eg chord estimation \cite{Humphrey2012tonnetz})
and pitch-\emph{invariant} (\eg instrument recognition \cite{Eronen2000}).
Both aim at disentangling pitch from timbral content as independent
factors of variability, a goal that is made possible by the third aforementioned property.
This is pursued by extracting mid-level features on top of the spectrogram,
be them engineered or learned from training data.
Both approaches have their limitations: a "bag-of-features" lacks flexibility
to represent fine-grain class boundaries, whereas a purely learned pipeline
often leads to uninterpretable overfitting, especially in MIR where the quantity
of thoroughly annotated data is relatively small.

In this article, we strive to integrate domain-specific knowledge about musical
pitch into a deep learning framework, in an effort towards bridging the gap
between feature engineering and feature learning.

Section 2 reviews the related work on feature learning for signal-based music
classification.
Section 3 demonstrates that pitch is the major factor of variability among musical
notes of a given instrument, if described by their mel-frequency cepstra.
Section 4 describes a typical deep learning architecture for spectrogram-based
classification, consisting of two convolutional layers and one densely connected layer.
Section 5 improves the previous architecture by splitting spectrograms into
octave-wide frequency bands, training specific convolutional layers over each band
in parallel, and gathering feature maps at a later stage.
Sections 6 discusses the effectiveness of the presented systems on a challenging
dataset for music instrument recognition.

\section{Related work}
Spurred by the growth of annotated datasets and the democratization of
high-performance computing, feature learning has enjoyed a renewed interest
in recent years within the MIR community, both in supervised and unsupervised
settings.
Whereas unsupervised learning (\eg $k$-means \cite{Stowell2014}, Gaussian
mixtures \cite{Joder2009}) is employed to fit the distribution of the data with
few parameters of relatively low abstraction
and high dimensionality, state-of-the-art supervised learning consists of a deep
composition of multiple nonlinear transformations, jointly optimized
to predict class labels, and whose behaviour tend to gain in abstraction as depth
increases \cite{vandenOord2013}.

As compared to other deep learning techniques for audio processing,
convolutional networks happen to strike the balance between
learning capacity and robustness.
The convolutional structure of learned transformations is derived from
the assumption that the input signal, be it a one-dimensional waveform
or a two-dimensional spectrogram, is stationary --- which means that
content is independent from location.
Moreover, the most informative dependencies between signal coefficients
are assumed to be concentrated to temporal or spectrotemporal neighborhoods.
Under such hypotheses, linear transformations can be learned efficiently
by limiting their support to a small kernel which is convolved over
the whole input.
This method, known as weight sharing, decreases the number of parameters
of each feature map while increasing the amount of data on which kernels are
trained.

By design, convolutional networks seem well adapted to the task of
instrument recognition, as it does not require precise timing of the activation function,
and is thus essentially a challenge of temporal integration \cite{Eronen2000, Joder2009}.
Furthermore, it benefits from an unequivocal annotation, and may be simplified
to a single-label classification problem by leveraging multitrack datasets \cite{Bittner2014}.
As such, it is often used a test bed for the development of new algorithms,
as well as in computational studies in music cognition \cite{Patil2012}.

Newton and Smith \cite{Newton2012} have built a network to represent the temporal 
dynamics of isolated musical notes.
They created a neurally inspired tone descriptor using a model of the auditory system's 
response to sound onset, based on dynamic synapses and leaky integrate-and-fire neurons.  
Final classification is then performed using an echo-state network in the time domain.

McFee \etal \cite{McFee2015-muda} have trained a deep convolutional network on
constant-Q spectrograms in order to illustrate the benefits of artificial data augmentation.
The authors successfully proved that the overfitting is reduced by randomly
manipulating the data with digital audio effects, such as
frequency transposition, time stretching, and the addition of realistic background noise.

Li \etal \cite{Li2015} have also trained a deep convolutional network, whose input is
the raw audio waveform instead of the spectrogram.
Their aim was to prove that an end-to-end approach could match shallow classifiers
in a challenging context of multilabel classification.
The authors also remark that the filters learned in the first layer are
frequency-selective, hence resembling an auditory filter bank.

Some other applications of deep convolutional networks include onset
detection \cite{Schluter2014}, transcription \cite{Sigtia2015},
chord recognition \cite{Humphrey2012tonnetz},
genre classification \cite{Choi2015},
downbeat tracking \cite{Durand2016},
boundary detection \cite{Ullrich2014}, and
recommendation \cite{vandenOord2013}.

Interestingly, many research teams in MIR have converged to employ the same
architecture, consisting of two convolutional layers and two densely connected layers
\cite{Dieleman2014, Humphrey2012tonnetz,
Kereliuk2015, Li2015, McFee2015-muda, Schluter2014, Ullrich2014}, and this
article makes no exception.
However, there is no clear consensus regarding the
weight sharing strategies that should be applied to musical audio streams:
convolutions in time or in time-frequency coexist in the recent literature.
A promising paradigm \cite{Dieleman2011, Durand2016}, at the interaction
between feature engineering and feature learning, is to extract
temporal or spectrotemporal descriptors of various low-level modalities,
train specific convolutional layers on each modality
to learn mid-level features, and aggregate information at the top level.
While this idea has been successfully applied to large-scale artist
recognition \cite{Dieleman2011} as well as downbeat tracking
\cite{Durand2016}, we aim to proceed in a comparable way for instrument
recognition.

\section{How invariant is the Mel-frequency cepstrum ?}
The mel scale is a quasi-logarithmic function of acoustic frequency designed such that
perceptually similar pitch intervals appear equal in width over the full hearing range.
This section shows that engineering transposition-invariant features from the mel
scale does not suffice to build pitch invariants for complex sounds, thus motivating
further inquiry.

The time-frequency domain produced by a constant-Q filter bank tuned to the mel
scale is covariant with respect to pitch transposition of pure tones.
As a result, a chromatic scale played at constant speed would draw parallel,
diagonal lines, each of them corresponding to a different partial wave.
However, the physics of musical instruments constrain these partial waves to bear
a negligible energy if their frequencies are beyond the range of acoustic resonance.

As shown on Figure \ref{fig:chromatic-scale}, the constant-Q spectrogram of a
tuba chromatic scale exhibits a fixed,
cutoff frequency at about $2.5\,\mathrm{kHz}$, which
delineates the support of its spectral envelope.
This elementary observation implies that realistic pitch changes cannot be modeled
by translating a rigid spectral template along the log-frequency axis.
The same property is verified for a wide class of instruments, especially brass and
woodwinds.
As a consequence, the construction of powerful invariants to musical pitch is not
amenable to delocalized operations on the mel-frequency spectrum, such as a
discrete cosine transform (DCT) which leads to the mel-frequency cepstral
coefficients (MFCC) classically used in music classification
\cite{Eronen2000, Joder2009}.

\begin{figure}[t]
    \begin{center}
        \setlength{\unitlength}{1cm}
        \begin{picture}(8.2,3)
        \put(0,-0.5){\includegraphics[width=8cm]{figs/chromatic_scale.png}}
        \end{picture}
    \end{center}
    \protect\caption{
    Constant-Q spectrogram of a chromatic scale played by a tuba.
    Although the harmonic partials shift progressively, the spectral envelope remains unchanged,
    as revealed by the presence of a fixed cutoff frequency.
    See text for details.
\label{fig:chromatic-scale}
}
\end{figure}

To validate the above claim, we have extracted the MFCC
of 1116 individual notes from the RWC dataset \cite{Goto2003},
as played by 6 instruments, with
32 pitches, 3 nuances,
and 2 interprets and manufacturers.
When more than 32 pitches were available (\eg piano), we selected
a contiguous subset of 32 pitches in the middle register.
Following a well-established rule \cite{Eronen2000, Joder2009},
the MFCC were defined the 12 lowest nonzero "quefrencies" among the
DCT coefficients extracted from a filter bank of 40 mel-frequency bands.
We then have computed the distribution of squared Euclidean distances
between musical notes in the 12-dimensional space of MFCC features.

Figure \ref{fig:mfcc-variances} summarizes our results.
We found that restricting the cluster to one nuance, one interpret, or one manufacturer
hardly reduces intra-class distances.
This suggests that MFCC are fairly successful in building invariant representations
to such factors of variability.
In contrast, the cluster corresponding to each instrument is shrinked if
decomposed into a mixture of same-pitch clusters, sometimes by an order of
magnitude.
In other words, most of the variance in an instrument cluster of mel-frequency
cepstra is due to pitch transposition.

Keeping less than 12 coefficients certainly improves invariance, yet at the cost of
inter-class discriminability, and vice versa.
This experiment shows that the mel-frequency cepstrum is perfectible in terms
of invariance-discriminability tradeoff, and that there remains a lot to be gained by
feature learning in this area.
\begin{figure}[t]
    \begin{center}
        \setlength{\unitlength}{1cm}
        \begin{picture}(8.5,8.7)
        \put(0.1,0){\includegraphics[width=8cm]{figs/mfcc_variances.png}}
        \end{picture}
    \end{center}
    \protect\caption{
Distributions of squared Euclidean distances among various MFCC clusters in the RWC dataset.
Whisker ends denote lower and upper deciles. See text for details.
\label{fig:mfcc-variances}
}
\end{figure}
\section{Deep convolutional networks}
A deep learning system for classification is built by stacking multiple layers of weakly nonlinear
transformations, whose parameters are optimized such that the top-level layer fits a training
set of labeled examples.
This section introduces a typical deep learning architecture for audio classification and describes
the functioning of each layer.

\begin{figure*}[t]
    \begin{center}
        \setlength{\unitlength}{1cm}
        \begin{picture}(17,5)
        \put(0,0){\includegraphics[width=17cm]{figs/architecture.png}}
        \end{picture}
    \end{center}
    \protect\caption{
A two-dimensional deep convolutional network trained on constant-Q spectrograms. See text for details.
\label{fig:instrument-distribution}
}
\end{figure*}

Each layer in a convolutional network typically consists in the composition of three operations:
two-dimensional convolutions, application of a pointwise nonlinearity, and local pooling.
The deep feed-forward network made of two convolutional layers and two densely connected
layers, on which our experiment are conducted,
has become a \emph{de facto} standard in the MIR community
\cite{Dieleman2014, Humphrey2012tonnetz,
Kereliuk2015, Li2015, McFee2015-muda, Schluter2014, Ullrich2014}.
This ubiquity in the literature suggests that the a four-layer network with two convolutional
layers is well adapted to supervised audio classification problems of moderate size.

The input of our system is a constant-Q wavelet scalogram, which is very comparable to a
mel-frequency spectrogram.
We used the implementation from the librosa package \cite{McFee2015-librosa} with $Q=12$
filters per octave, center frequencies ranging from $\mathrm{A_1}$ ($55\,\mathrm{Hz}$)
to $\mathrm{A_9}$ ($14\,\mathrm{kHz}$), and a hop size of $23\,\mathrm{ms}$.
Furthermore, we applied nonlinear perceptual weighting of loudness in order to reduce the
dynamic range between the fundamental partial and its upper harmonics.
A $3$-second sound excerpt $\boldsymbol{x}[t]$ is represented by a time-frequency matrix
$\boldsymbol{x_1}[t,k_1]$ of width $T=128$ samples and height $K_1=96$ frequency bands.

A convolutional operator is defined as a family $\boldsymbol{W_2}[\tau,\kappa_1,k_2]$ of
$K_2$ two-dimensional filters, whose impulse repsonses are all constrained to have width
$\Delta t$ and height $\Delta k_1$. Element-wise biases $\boldsymbol{b_2}[k_2]$ are
added to the convolutions, resulting in the three-way tensor 
\begin{IEEEeqnarray}{rCl}
\IEEEeqnarraymulticol{3}{l}{
\boldsymbol{y_2}[t,k_1,k_2]} \nonumber \\
& = & \boldsymbol{b_2}[k_2] + 
\boldsymbol{W_2}[t, k_1, k_2] \overset{t,k_1}{\ast} \boldsymbol{x_1}[t, k_1]
\nonumber \\
& = &
\boldsymbol{b_2}[k_2] + 
\sum_{\substack{
0 \leq \tau < \Delta t \\
0 \leq \kappa_1 < \Delta k_1}}
\! \! \! \! \!
\boldsymbol{W_2}[\tau, \kappa_1, k_2]
\boldsymbol{x_1}[t-\tau, k_1-\kappa_1].
\IEEEeqnarraynumspace
\label{eq:convolution2d}
\end{IEEEeqnarray}
The pointwise nonlinearity we have chosen is the rectified linear unit (ReLU),
with a rectifying slope of $\alpha=0.3$ for negative inputs.
\begin{IEEEeqnarray}{l}
\boldsymbol{y_{2}^{+}}[t,k_{1},k_{2}]=\left\{ \! \! \! \begin{array}{r}
\alpha\boldsymbol{x_{2}}[t,k_{1},k_{2}] \;\;\; \mbox{if} \;\; \boldsymbol{x_{2}}[t,k_{1},k_{2}]<0\\
\boldsymbol{x_{2}}[t,k_{1},k_{2}] \;\;\; \mbox{if} \;\; \boldsymbol{x_{2}}[t,k_{1},k_{2}]>0
\end{array}\right. \!
\IEEEeqnarraynumspace
\label{eq:relu}
 \end{IEEEeqnarray}
The pooling step consists in retaining the maximal activation among neighboring units in the
time-frequency domain $(t, k_1)$ over non-overlapping rectangles of width $\Delta t$ and
height $\Delta k_1$.
\begin{equation}
\boldsymbol{x_2}[t,k_1,k_2] = \! \!
\max_{
\substack{
0 \leq \tau < \Delta t \\
0 \leq \kappa_1 < \Delta k_1}
} \! \!
\left\{
\boldsymbol{y_{2}^{+}}[t - \tau, k_1 - \kappa_1, k_2]
\right\}
\label{eq:pooling}
\end{equation}
The hidden units in $\boldsymbol{x_2}$ are in turn fed to a second layer of convolutions,
ReLU, and pooling.
Observe that the corresponding convolutional operator
$\boldsymbol{W_3}[\tau, \kappa_1, k_2, k_3]$ performs a linear combination of time-frequency
feature maps in $\boldsymbol{x_2}$ along the channel variable $k_2$.
\begin{IEEEeqnarray}{rCl}
\IEEEeqnarraymulticol{3}{l}{
\boldsymbol{y_3}[t,k_1,k_3]} \nonumber \\
& = &
\sum_{k_2}
\boldsymbol{b_3}[k_2, k_3]
+ \boldsymbol{W_3}[t, k_1, k_2, k_3]
\overset{t,k_1}{\ast}
\boldsymbol{x_2}[t,k_1,k_2].
\IEEEeqnarraynumspace
\end{IEEEeqnarray}
Tensors $\boldsymbol{y_3^{+}}$ and $\boldsymbol{x_3}$ are derived from $\boldsymbol{y_3}$
by ReLU and pooling, with formulae similar to Eqs. (\ref{eq:relu}) and (\ref{eq:pooling}).
The third layer consists of the linear projection of $\boldsymbol{x_3}$, viewed as a vector of
the flattened index $(t, k_1, k_3)$, over $K_4$ units:
\begin{IEEEeqnarray}{rCl}
\boldsymbol{y_4}[k_4] =
\boldsymbol{b_4}[k_4] +
\sum_{t,k_1,k_3}
\boldsymbol{W_4}[t, k_1, k_3, k_4]
\boldsymbol{x_3}[t, k_1, k_3]
\label{eq:densely-connected-layer}
\IEEEeqnarraynumspace
\end{IEEEeqnarray}
We apply a ReLU to $\boldsymbol{y_4}$, yielding
$\boldsymbol{x_4}[k_4] = \boldsymbol{y_4^{+}}[k_4]$.
Finally, we project $\boldsymbol{x_4}$ onto a layer of output units $\boldsymbol{y_5}$ that
should represent instrument activations:
$\boldsymbol{y_5}[k_5] = \sum_{k_4} \boldsymbol{W_5}[k_4, k_5] \boldsymbol{x_4}[k_4]$.
The final transformation is a softmax nonlinearity, which ensures that output coefficients are
non-negative and sum to one, hence can be fit to a probability distribution:
\begin{equation}
\boldsymbol{x_5}[k_5] =
\frac{\exp \boldsymbol{y_5}[k_5]}
{  \sum_{\kappa_5} \exp \boldsymbol{y_5}[\kappa_5] }.
\end{equation}
Given a training set of spectrogram-instrument pairs $(\boldsymbol{x_1}, k)$,
all weigths in the network are iteratively updated to minimize the cross-entropy loss
$\mathscr{L}(\boldsymbol{x_5}, k) = - \log \boldsymbol{x_5}[k]$
over shuffled mini-batches of size $32$ with uniform class distribution.
The pairs $(\boldsymbol{x_1}, k)$ are extracted on the fly by selecting non-silent
regions at random within a dataset of single-instrument audio recordings.
Each $3$-second spectrogram $\boldsymbol{x_1}[t, k_1]$ within a batch is
globally normalized such that the whole batch had zero mean and unit variance.
At training time, a random dropout of 50\% is applied to the activations of
$\boldsymbol{x_3}$ and $\boldsymbol{x_4}$.
The learning rate policy for each scalar weight in the network is Adam \cite{Kingma2015},
a state-of-the-art online optimizer for gradient-based learning.
Mini-batch training is stopped after the average training loss stopped
decreasing over one full epoch of size $8192$.
The architecture is built using the Keras library \cite{Chollet2015}
and trained on a graphics processing unit within a few minutes.

\section{Improved weight sharing strategies}
Although a dataset of music signals is unquestionably stationary over the time
dimension -- at least at the scale of a few seconds -- it cannot be taken for granted
that all frequency bands of a mel-frequency spectrogram would have the same
local statistics \cite{Humphrey2013}.
In this section, we introduce two alternative architectures to address
nonstationarity of music on the mel-frequency axis,
while still leveraging the efficiency of convolutional representations in the
time-frequency domain.
 % ELABORATE ?
Some objections the stationarity assumption among local neighborhoods in frequency
are the following:
the spectral envelope of musical instruments remains fixed in spite of
pitch changes (see Section 2) ;
partials of a harmonic comb get closer to each other in high frequencies on a mel scale ;
due to the Heisenberg principle, the temporal resolution of auditory filters is lessened at
lower frequencies.

\subsection{One-dimensional convolutions at high frequencies}
Facing nonstationary constant-Q spectra,
the most conservative workaround is to increase the height $\Delta \kappa_1$ of each
convolutional kernel up to the total number of bins $K_1$ in the spectrogram.
As a result, $\boldsymbol{W_1}$ and $\boldsymbol{W_2}$ are no longer transposed
over adjacent frequency bands, since convolutions are merely performed over
the time variable.
The definition of $\boldsymbol{y_2}[t, k_1, k_2]$ rewrites as
\begin{IEEEeqnarray}{rCl}
\IEEEeqnarraymulticol{3}{l}{
\boldsymbol{y_2}[t,k_1,k_2]} \nonumber \\
& = & \boldsymbol{b_2}[k_2] + 
\boldsymbol{W_2}[t, k_1, k_2] \overset{t}{\ast} \boldsymbol{x_1}[t, k_1]
\nonumber \\
& = &
\boldsymbol{b_2}[k_2] + 
\sum_{\substack{0 \leq \tau < \Delta t}}
\! \! \! \! \!
\boldsymbol{W_2}[\tau, k_1, k_2]
\boldsymbol{x_1}[t-\tau, k_1],
\IEEEeqnarraynumspace
\label{eq:convolution1d}
\end{IEEEeqnarray}
and similarly for $\boldsymbol{y_3}[t, k_1, k_3]$.
While this approach is theoretically capable of encoding pitch invariants, it is
prone to early specialization of low-level features, thus
not fully taking advantage of the network depth.

However, the situation is improved if the one-dimensional
kernels are restricted to the highest frequencies in the constant-Q spectrum.
It should be observed that, around the $n^{\textrm{th}}$ partial of a quasi-harmonic sound,
the distance in log-frequency between neighboring partials decays like $1/n$,
and the unevenness between those distances decays like $1/n^2$.
Consequently, at the topmost octaves of the constant-Q spectrum, 
where $n$ is equal or greater than $Q$, the partials appear close to each other and almost
evenly spaced.
Furthermore, due to the logarithmic compression of loudness, the polynomial decay
of the spectral envelope is linearized: thus, at high frequencies, transposed pitches
have similar spectra up to some additive bias.
The combination of these two phenomena implies that the correlation between
constant-Q spectra of different pitches is greater towards high frequencies, and that
the learning of polyvalent feature maps becomes tractable.


In our experiments, the one-dimensional convolutions over the time variable
range from
$\mathrm{A_6}$ ($1,76\,\mathrm{kHz}$) to
$\mathrm{A_9}$ ($14\,\mathrm{kHz}$).

\subsection{Convolutions on the pitch spiral at low frequencies}
The weight sharing strategy presented above exploits the facts that,
at high frequencies, quasi-harmonic partials are numerous, and that the
amount of energy within a frequency band is independent of pitch.
At low frequencies, we make the exact opposite assumptions: we claim
that the harmonic comb is sparse and covariant with respect to pitch shift.
Observe that, for any two distinct partials taken at random between $1$ and $n$,
the probability that they are in octave relation is slightly above $1/n$.
Thus, for $n$ relatively low, the structure of harmonic sounds is well
described by merely measuring correlations between partials one octave apart,
\ie between log-frequency bands $k_1$ and $k_1 \pm Q$.

%To leverage the fact that power-of-two harmonics are one octave apart,
%we make the Euclidean division $k_1 = Q \times j_1 + q_1$, hence revealing
%the octave variable $j_1$ and the chroma variable $q_1$.
%Conceptually, this corresponds to rolling up the log-frequency axis
%into a Shepard pitch spiral, such that octave intervals correspond to full turns.
Each feature map $k_2$ results from the sum of $j_1 = 3$ convolutions between
time-frequency kernels of size $(\Delta t \times \Delta k_1)$.
The definition of $\boldsymbol{y_2}[t, k_1, k_2]$ rewrites as
\begin{IEEEeqnarray}{rCl}
\boldsymbol{y_2}[t,k_1,k_2]
= & &
\! \! \! \! \! \! \! \! \! \! \! \! \! \! \! \! \! \! \! \!
\boldsymbol{b_2}[k_2]  \nonumber \\
& +
\! \sum_{\tau, \kappa_1, j_1} \! &
\boldsymbol{W_2}[\tau, \kappa_1, j_1, k_2] \nonumber \\
& &\times
\boldsymbol{x_1}[t - \tau, k_1 - \kappa_1 - Q j_1]
\IEEEeqnarraynumspace
\end{IEEEeqnarray}
The above is different from training two-dimensional kernel on
a time-chroma-octave tensor, since it does not suffer from border effects
at octave boundaries.

The linear combinations of frequency bands that are one octave apart,
as proposed here,
bears a resemblance with engineered features for music instrument
recognition \cite{Peeters2004}, such as tristimulus, 
empirical inharmonicity, harmonic spectral deviation,
odd-to-even harmonic energy ratio, as well as
octave band signal intensities (OBSI) \cite{Joder2009}.

Guaranteeing the partial index $n$ to remain low is achieved by
restricting the pitch spiral to its lowest frequencies.
This operation also partially circumvents the problem of fixed spectral envelope
in musical sounds, thus improving the validness of the stationarity assumption.
In our experiments, the pitch spiral ranges from
$\mathrm{A_2}$ ($110\,\mathrm{Hz}$) to
$\mathrm{A_6}$ ($1,76\,\mathrm{kHz}$).

In summary, the classical two-dimensional convolutions make a stationarity assumption
among frequency neighborhoods. This approach gives a coarse approximation
of the spectral envelope.
Resorting to one-dimensional convolutions allows to disregard nonstationarity,
but does not yield a pitch-invariant representation per se:
thus, we only apply them at the topmost frequencies, \ie where the
invariance-to-stationarity ratio in the data is already favorable.
Conversely, two-dimensional convolutions on the pitch spiral addresses
the invariant representation of sparse, transposition-covariant spectra:
as such, they are best suited to the lowest frequencies,
\ie where partials
are further apart and pitch changes can be approximated by log-frequency
translations.
The next section reports experiments on instrument recognition that capitalize
on these considerations.

\section{Applications}\label{sec:single-instrument}
In order to train the proposed algorithms, we used MedleyDB v1.1. \cite{Bittner2014}, a
dataset of 122 multitracks annotated with instrument activations. 
We extracted the monophonic stems corresponding to a selection of eight pitched
instruments (see Table \ref{table:single-label-durations}).
Stems with leaking instruments in the background were discarded.

\begin{table}
	\begin{center}
	\begin{tabular}{|c|cc|cc|}
		\hline
		& minutes & tracks & minutes & tracks \\
		\hline
		clarinet & 10 & 7 & 13 & 18 \\
		dist. guitar & 15 & 14 & 17 & 11 \\
		female singer & 10 & 11 & 19 & 12 \\
		flute & 7 & 5 & 53 & 29 \\
		piano & 58 & 28 & 44 & 15 \\
		tenor sax. & 3 & 3 & 6 & 5 \\
		trumpet & 4 & 6 & 7 & 27 \\
		violin & 51 & 14 & 49 & 22 \\
		\hline
		total & 158 & 88 & 208 & 139 \\
		\hline
	\end{tabular}
	\end{center}
	\caption{
	Quantity of data in the training set (left) and test set (right).
	The training set is derived from MedleyDB.
	The test set is derived from MedleyDB for distorted electric guitar and female singer,
	and from \cite{Joder2009} for other instruments.
	\label{table:single-label-durations}}
\end{table}

The evaluation set consists of 126 recordings of solo music collected by
Joder \etal \cite{Joder2009}, supplemented with
23 stems of electric guitar and female voice from MedleyDB.
In doing so, guitarists and vocalists were thoroughly put either in the training set or the test set,
to prevent any artist bias.
We discarded recordings with extended instrumental techniques, since they are
extremely rare in MedleyDB.

Constant-Q spectrograms from the evaluation set were split into half-overlapping,
3-second excerpts.
The predicted probability distributions were computed for every excerpt in a track,
and then aggregated by geometric mean to provide a decision at the scale of
the entire audio file.

Standard deviations for the test accuracies were estimated by training all architectures
ten times with random initialization \cite{He2015}.

In order to compare the results against shallow classifiers, we also extracted a typical
"bag-of-features" over half-overlapping, 3-second excerpts in the training set.
These features consist of the means and standard
deviations of spectral shape descriptors, \ie centroid, bandwidth, skewness,
and rolloff ; the mean and standard deviation of the zero-crossing rate in the time domain ;
the mean MFCC as well their first and second derivative.
We trained a random forest of $100$ decision trees on the resulting feature vector
of dimension $70$.

Results are summarized in Table \ref{table:results}.

\begin{table*}[t]
	\begin{center}
	\setlength{\unitlength}{1cm}
	\begin{tabular}{|c|cccccccc|c|}
		\hline
		& clarinet & distorted & female & flute & piano & tenor & trumpet & violin & average \\
		\hline
		bag-of-features
		& 49.9 & 92.7 & 81.6 & 22.5 & \textbf{99.7} & \hphantom{0}4.4 & 63.7 & 76.2 & 61.3 \\
		\hline
		
		2-d
		& 59.9 & \textbf{94.0} & 90.5 & 30.4 & \textbf{99.7} & 56.3 & 61.6 & 79.4 & 71.5 \\
		1-d
		& 32.3 & 91.5 & 88.2 & 66.4 & 75.7 & 56.6 & 70.7 & 53.1 & 66.8 \\
		spiral
		& 70.2 & 70.3 & 68.4 & 31.2 & 74.8 & 33.8 & 45.8 & 25.9 & 52.6 \\
		\hline
		2-d \& 1-d
		& 80.1 & 90.9 & \textbf{90.7} & 34.2 & 94.3 & \textbf{76.0} & 62.0 & \textbf{83.0} & \textbf{76.5} \\
		2-d \& spiral
		& \textbf{84.9} & 90.4 & 90.2 & \textbf{50.4} & 98.6 & 53.2 & \textbf{63.5} & 71.0 & 75.3\\
		\hline
		2-d \& 1-d \& spiral
		& 76.6 & 84.6 & 87.3 & 38.6 & 99.0 & 70.2 & 57.4 & 70.8 & 73.8  \\
		\hline
	\end{tabular}
	\end{center}
	\caption{\label{table:results}}
\end{table*}


\section{Conclusions}
Understanding the influence of pitch in audio streams is paramount to the design of
an efficient system for automated classification, tagging, and similarity retrieval in music. 
We have presented a supervised, end-to-end learning method to address pitch invariance
while preserving good timbral discriminability.
It consists in training a feed-forward convolutional network over the constant-Q spectrogram,
with three different weight sharing strategies according to the type of input:
along time at high frequencies (above $2\,\mathrm{kHz}$),
on a pitch spiral at low frequencies (below $2\,\mathrm{kHz}$),
and in time-frequency over both high and low frequencies.

A possible improvement of the presented architecture would be to
place a third convolutional layer in the time domain before performing long-term
max-pooling, hence modelling the joint dynamics of the three mid-level feature maps.
Future work will investigate the association of the presented weight sharing strategies
with recent advances in deep learning for music informatics,
such as data augmentation \cite{McFee2015-muda},
multiscale representations \cite{Hamel2012, Anden2015},
and adversarial training \cite{Kereliuk2015}.

% For bibtex users:
\bibliography{lpifir_ismir2016}

\end{document}
